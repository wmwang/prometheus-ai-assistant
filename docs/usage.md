# 使用手冊

本文件說明 Prometheus AI Assistant 的各項功能與使用方式。

## 功能概覽

### 1. 自然語言查詢

將你用白話文描述的查詢需求，自動轉換為 PromQL。

**使用方式：**

1. 點擊右下角的 🤖 按鈕開啟 AI 助手
2. 在輸入框中輸入你的查詢需求
3. 按 Enter 或點擊送出按鈕
4. AI 會生成對應的 PromQL

**查詢範例：**

| 自然語言 | 生成的 PromQL |
|----------|--------------|
| 顯示所有節點的 CPU 使用率 | `100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)` |
| 過去5分鐘每秒請求數 | `rate(http_requests_total[5m])` |
| 錯誤率超過1%的服務 | `rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.01` |
| 記憶體使用超過80%的節點 | `(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.8` |
| P95 請求延遲 | `histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))` |
| 顯示過去1小時請求量前10名的服務 | `topk(10, sum by (job) (increase(http_requests_total[1h])))` |

**進階技巧：**

- 明確指定時間範圍：「過去1小時」、「最近5分鐘」
- 指定聚合維度：「按服務分組」、「按節點統計」
- 設定閾值：「超過80%」、「小於100ms」

### 2. 執行查詢

生成 PromQL 後，你可以直接在 Prometheus UI 中執行。

**使用方式：**

1. 生成 PromQL 後，點擊「▶ 執行查詢」按鈕
2. AI 助手會自動將 PromQL 填入 Prometheus 的查詢框
3. 並嘗試觸發執行

**備註：** 由於 Prometheus UI 的版本差異，自動執行可能不完全相容。此時可以使用「📋 複製」按鈕，手動貼上查詢。

### 3. 見解分析

對查詢結果進行智能分析，提供趨勢、異常、效能見解。

**使用方式：**

1. 執行查詢後，點擊「💡 分析見解」按鈕
2. AI 會分析查詢結果並提供見解

**見解類型：**

| 類型 | 說明 | 範例 |
|------|------|------|
| 趨勢 (Trend) | 識別上升/下降趨勢 | 「過去1小時請求量增加了45%」 |
| 異常 (Anomaly) | 偵測異常值 | 「node-3 的 CPU 使用率異常偏高」 |
| 效能 (Performance) | 效能相關見解 | 「P95 延遲超過 SLO 目標」 |
| 資源 (Resource) | 資源使用分析 | 「記憶體使用接近容量上限」 |

### 4. 下一步建議

根據當前的分析結果，AI 會建議相關的進階查詢。

**使用方式：**

1. 完成見解分析後，會顯示「建議下一步」區塊
2. 每個建議都包含說明和對應的 PromQL
3. 點擊建議項目即可執行該查詢

**範例情境：**

當你查詢「服務錯誤率」後，AI 可能建議：

- 「查看錯誤的詳細狀態碼分布」
- 「檢查相關的延遲指標」
- 「查看 Pod 重啟次數」

## 設定

### 後端 API 位址

預設為 `http://localhost:3001`，如需修改：

1. 點擊工具列中的擴充功能圖示
2. 在「後端 API 位址」欄位輸入新位址
3. 點擊「儲存設定」

### 連線狀態

在擴充功能彈出視窗中可以查看：

- **後端服務**: API 伺服器連線狀態
- **Prometheus**: Prometheus 連線狀態
- **OpenAI**: API Key 設定狀態

## 常見問題

### Q: AI 生成的 PromQL 不正確怎麼辦？

A: 嘗試更具體地描述你的需求：
- 明確指定指標名稱（如果知道的話）
- 說明時間範圍
- 指定聚合方式

### Q: 為什麼有些查詢沒有結果？

A: 可能原因：
- 指標名稱不存在於你的 Prometheus
- 標籤篩選條件不符合
- 時間範圍內沒有數據

你可以先使用 `/api/metrics` 端點查看可用的指標。

### Q: 見解分析速度很慢？

A: 見解分析需要：
1. 執行 Prometheus 查詢
2. 將結果發送給 OpenAI 分析

如果數據量很大，建議縮小查詢範圍或增加聚合。

## 鍵盤快捷鍵

| 快捷鍵 | 功能 |
|--------|------|
| Enter | 送出查詢 |
| Shift + Enter | 在輸入框中換行 |
| Esc | 關閉 AI 助手面板 |
